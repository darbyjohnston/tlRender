name: CI

on: [push]

jobs:
  linux-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Update
      run: sudo apt-get update

    - name: Install lcov
      run: sudo apt-get install lcov

    - name: Install OpenGL dev
      run: sudo apt-get install xorg-dev libglu1-mesa-dev mesa-common-dev

    - name: Install Python dev
      run: sudo apt-get install python3.8-dev

    - name: Build tlRender
      run: >
        mkdir build &&
        cd build &&
        export PATH=$PATH:$PWD/install/bin &&
        export LD_LIBRARY_PATH=$PWD/install/lib:$LD_LIBRARY_PATH &&
        export PYTHONPATH=$PWD/install/lib:$PYTHONPATH &&
        cmake ../etc/SuperBuild \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_INSTALL_PREFIX=$PWD/install \
          -DCMAKE_PREFIX_PATH=$PWD/install &&
        cmake --build . -j 4

    - name: Run tests
      run: >
        cd build &&
        export PATH=$PATH:$PWD/install/bin &&
        export LD_LIBRARY_PATH=$PWD/install/lib:$LD_LIBRARY_PATH &&
        export PYTHONPATH=$PWD/install/lib:$PYTHONPATH &&
        cd tlRender/src/tlRender-build &&
        cmake --build . --target test &&
        export CTEST_OUTPUT_ON_FAILURE=1 &&
        cat Testing/Temporary/LastTest.log

  macos-build:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2

    - name: Build tlRender
      run: >
        mkdir build &&
        cd build &&
        export PATH=$PATH:$PWD/install/bin &&
        export DYLD_LIBRARY_PATH=$PWD/install/lib:$DYLD_LIBRARY_PATH &&
        export PYTHONPATH=$PWD/install/lib:$PYTHONPATH &&
        cmake ../etc/SuperBuild \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_INSTALL_PREFIX=$PWD/install \
          -DCMAKE_PREFIX_PATH=$PWD/install &&
        cmake --build . -j 4

    # \bug Running "cmake --build . --target test" fails by not finding
    # shared libraries on macOS, it seems like DYLD_LIBRARY_PATH is not
    # working? Running the test directly does work with DYLD_LIBRARY_PATH.
    - name: Run tests
      run: >
        cd build &&
        export PATH=$PATH:$PWD/install/bin &&
        export DYLD_LIBRARY_PATH=$PWD/install/lib:$DYLD_LIBRARY_PATH &&
        export PYTHONPATH=$PWD/install/lib:$PYTHONPATH &&
        cd tlRender/src/tlRender-build &&
        tests/tlrtest/tlrtest

  windows-build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2

    - name: Setup environment
      run: >
        echo "$pwd\build\install\bin" >> $GITHUB_PATH &&
        echo "CTEST_OUTPUT_ON_FAILURE=1" >> $GITHUB_ENV &&
        echo $pwd

    - name: Build tlRender
      run: >
        mkdir build &&
        cd build &&
        cmake ..\etc\SuperBuild `
          -DTLR_BUILD_JPEG=FALSE `
          -DTLR_BUILD_TIFF=FALSE `
          -DCMAKE_BUILD_TYPE=Debug `
          -DCMAKE_INSTALL_PREFIX=install `
          -DCMAKE_PREFIX_PATH=install &&
        cmake --build . -j 4

    - name: Run tests
      run: >
        cd build &&
        cd tlRender\src\tlRender-build &&
        cmake --build . --target test &&
        type Testing\Temporary\LastTest.log
